name: Python package test

on:
  schedule:
    - cron: '0 8 * * 1,4'  
  push:
    branches: [main]
    tags: ['*']
  pull_request:
    branches: ['**']
  workflow_call:
    inputs:
      override-deps-artifact:
        description: "Name of artifact containing updated lockfiles"
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: "ðŸ“ Pre-commit / Code Quality"
    runs-on: ubuntu-latest
    # Skip linting when triggered by the Sync Workflow (it just updated locks)
    if: github.event_name != 'workflow_call'
    steps:
      - uses: actions/checkout@v4
      - name: âš¡ Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: ðŸƒ Run Pre-commit
        run: |
          uv tool install pre-commit
          uv tool run pre-commit run --show-diff-on-failure --all-files

  setup:
      name: "ðŸ—ï¸ Build Py${{ matrix.python-version }}"
      needs: lint
      runs-on: ubuntu-latest
      strategy:
        matrix:
          python-version: ["3.10", "3.11", "3.12", "3.13"]
      container: ghcr.io/osgeo/gdal:ubuntu-small-latest
      steps:
        - uses: actions/checkout@v4

        - name: ðŸ“¥ Apply Dependency Overrides
          if: "${{ inputs.override-deps-artifact != '' && inputs.override-deps-artifact != 'null' }}"
          uses: actions/download-artifact@v4
          with:
            name: ${{ inputs.override-deps-artifact }}

        - name: âš¡ Install uv
          run: |
            apt-get update && apt-get install -y curl
            curl -LsSf https://astral.sh/uv/install.sh BINDIR=/usr/local/bin | sh

        - name: ðŸ“ Export Locked Requirements
          run: |
            uv export --frozen --all-extras --format requirements-txt > requirements.txt
      
        - name: ðŸ“¤ Upload Requirements
          uses: actions/upload-artifact@v4
          with:
            name: frozen-reqs-${{ matrix.python-version }}
            path: requirements.txt
            retention-days: 1

  test:
    needs: setup
    name: "ðŸ§ª py${{ matrix.python-version }} [${{ matrix.split }}/4]"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        split: [1, 2, 3, 4]
    steps:
      - uses: actions/checkout@v4
      - name: ðŸ“¥ Download Requirements
        uses: actions/download-artifact@v4
        with:
          name: frozen-reqs-${{ matrix.python-version }}     
      
      - name: âš¡ Install uv, git & GIS Dependencies
        run: |
          sudo apt-add-repository -y ppa:ubuntugis/ubuntugis-unstable
          sudo apt-get update
          sudo apt-get install -y curl git gpg gdal-bin libgdal-dev libproj-dev libgeos-dev g++

          curl -LsSf https://astral.sh/uv/install.sh | env UV_INSTALL_DIR="/usr/local/bin" sh          
          
          docker compose --version
          uv --version

      - name: ðŸ—ï¸ Restore Native Env
        run: |
          uv venv --python ${{ matrix.python-version }}
          uv pip install -r requirements.txt
          uv pip install -e ".[test]" --no-deps      

      - name: ðŸ³ Start containers (MinIO & Nginx)
        run: |
          docker compose -f "test/docker-compose.yml" up -d
          
      - name: ðŸ§ª Run Tests (Split ${{ matrix.split }}/4)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REQUEST_PAYER: ${{ vars.AWS_REQUEST_PAYER }}
          AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
          CURL_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
          COVERAGE_FILE: .coverage.python.${{ matrix.python-version }}.test.split.${{ matrix.split }}
        run: |
            uv run pytest -v \
            --splits 4 \
            --group ${{ matrix.split }} \
            --cov=mapchete \
            --cov-report=xml:coverage.xml \
            --junitxml="pytest-${{ matrix.python-version }}-${{ matrix.split }}.xml"

      - name: ðŸ“Š Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: py${{ matrix.python-version }}-split${{ matrix.split }}
          fail_ci_if_error: true

      - name: ðŸ“¤ Upload Coverage Chunk (Latest Only)
        if: matrix.python-version == '3.13'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-chunk-${{ matrix.split }}
          path: .coverage.python.${{ matrix.python-version }}.test.split.${{ matrix.split }}
          include-hidden-files: true
          retention-days: 1

      - name: ðŸ“¤ Archive JUnit Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.python-version }}-${{ matrix.split }}
          path: pytest-${{ matrix.python-version }}-${{ matrix.split }}.xml
          retention-days: 1

  summary:
    name: "ðŸ“Š Final Summary & Coverage"
    needs: test
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # Needed for coverage to see source files

      - name: âš¡ Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: ðŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results
          pattern: "*-*" 
          merge-multiple: true

      - name: ðŸ“Š Check Tests & Coverage
        run: |
          echo "### ðŸ§ª Test & Coverage Summary" >> $GITHUB_STEP_SUMMARY
          
          # 1. CHECK OVERALL TEST STATUS
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "âŒ **Test Suite Failed**" >> $GITHUB_STEP_SUMMARY
            echo "Coverage check skipped because tests failed." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "âœ… **Test Suite Passed**" >> $GITHUB_STEP_SUMMARY

          # 2. COMBINE COVERAGE (Only 3.13 files exist here)
          uv tool install coverage
          
          # Move the specific files to root
          mv all-results/.coverage* .
          
          # ðŸ§¹ Delete any empty (0-byte) coverage files that cause exit code 2
          echo "Cleaning up empty or invalid coverage artifacts..."
          find . -maxdepth 1 -name ".coverage*" -size 0 -print -delete
          
          echo "Merging coverage files..."
          
          # Disable automatic exit on error temporarily so we can catch the crash
          set +e
          uv tool run coverage combine
          COMBINE_EXIT=$?
          set -e
          
          # ðŸž If it still fails, run it again in debug mode so the logs show the exact corrupted file or path issue
          if [ $COMBINE_EXIT -ne 0 ]; then
              echo "âŒ 'coverage combine' crashed! Running with debug trace..."
              uv tool run coverage combine --debug=data,sys,pathmap
              exit $COMBINE_EXIT
          fi
          
          # 3. ENFORCE 100%
          echo "Generating coverage report..."
          
          # Temporarily disable exit-on-error so a failed report doesn't kill the script!
          set +e
          OUTPUT=$(uv tool run coverage report --show-missing --fail-under=100 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo "$OUTPUT"
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ **Coverage Failed:** Python 3.13 coverage check failed." >> $GITHUB_STEP_SUMMARY
            exit $EXIT_CODE
          else
            echo "âœ… **Coverage Passed:** 100% coverage achieved (Py3.13)." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi