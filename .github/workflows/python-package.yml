name: Python package test

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
  pull_request:
    branches: [main]
    paths-ignore:
      - "conda/meta.yaml"     
  schedule:
    - cron: '0 8 * * 1,4'
  workflow_call:
    inputs:
      override-deps-artifact:
        description: "Name of artifact containing updated lockfiles"
        required: false
        type: string    

jobs:
  setup:
      name: "ðŸ—ï¸ Build Py${{ matrix.python-version }}"
      runs-on: ubuntu-latest
      strategy:
        matrix:
          python-version: ["3.10", "3.11", "3.12", "3.13"]
      container: ghcr.io/osgeo/gdal:ubuntu-small-latest
      steps:
        - uses: actions/checkout@v4

        - name: âš¡ Install uv
          run: |
            apt-get update && apt-get install -y curl
            curl -LsSf https://astral.sh/uv/install.sh | BINDIR=/usr/local/bin sh

        - name: ðŸ“ Export Locked Requirements
          run: |
            uv export --frozen --all-extras --format requirements-txt > requirements.txt
      
        - name: ðŸ“¤ Upload Requirements
          uses: actions/upload-artifact@v4
          with:
            name: frozen-reqs-${{ matrix.python-version }}
            path: requirements.txt
            retention-days: 1

  test:
    needs: setup
    name: "ðŸ§ª py${{ matrix.python-version }} [${{ matrix.split }}/4]"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        split: [1, 2, 3, 4]
    container: ghcr.io/osgeo/gdal:ubuntu-small-latest
    steps:
      - uses: actions/checkout@v4
      - name: ðŸ“¥ Download Requirements
        uses: actions/download-artifact@v4
        with:
          name: frozen-reqs-${{ matrix.python-version }}

      - name: ðŸ“¥ Apply Dependency Overrides
        if: "${{ inputs.override-deps-artifact != '' }}"
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.override-deps-artifact }}          
      
      - name: âš¡ Install uv, Docker Compose & git
        run: |
          apt-get update && apt-get install -y curl git gpg

          curl -fsSL https://get.docker.com -o get-docker.sh
          sh get-docker.sh

          curl -SL https://github.com/docker/compose/releases/download/v2.24.6/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose

          curl -LsSf https://astral.sh/uv/install.sh | env UV_INSTALL_DIR="/usr/local/bin" sh

          docker-compose --version
          uv --version

      - name: ðŸ—ï¸ Restore Native Env
        run: |
          uv venv --python ${{ matrix.python-version }}
          uv pip install -r requirements.txt
          uv pip install -e ".[test]" --no-deps

      - name: ðŸ³ Start containers (CI Patch; !Gemini made this!)
        working-directory: test
        run: |
          # --- [Existing Python Patch Script] ---
          uv run --with pyyaml python -c "
          import yaml
          with open('docker-compose.yml') as f:
              data = yaml.safe_load(f)
          if 'volumes' in data['services'].get('nginx', {}):
              del data['services']['nginx']['volumes']
          with open('docker-compose.yml', 'w') as f:
              yaml.dump(data, f)
          "
          
          # Start & Inject
          docker-compose up -d
          docker-compose cp nginx.conf nginx:/etc/nginx/nginx.conf
          docker-compose cp .htpasswd nginx:/etc/nginx/.htpasswd
          docker-compose cp testdata nginx:/tmp/testdata
          docker-compose exec -T nginx sh -c "cp -r /tmp/testdata/. /usr/share/nginx/html/ && cp -r /tmp/testdata /usr/share/nginx/html_secure"
          docker-compose restart nginx

          # 2ï¸âƒ£ FIX: Connect to Network & Wait
          echo "ðŸ”Œ Connecting to Docker Network..."
          docker network connect test_default $(hostname)

          echo "â³ Waiting for Nginx..."
          # Retry loop with explicit output
          # We accept 200 (OK), 403 (Forbidden), or 404 (Not Found) as "Alive"
          # (Because even a 404 means the server is reachable and running!)
          count=0
          while [ $count -lt 30 ]; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://nginx:80/ || echo "000")
            
            if [[ "$STATUS" == "200" || "$STATUS" == "403" || "$STATUS" == "404" ]]; then
              echo "âœ… Nginx is up! (Status: $STATUS)"
              break
            fi
            
            echo "zzz... (Status: $STATUS)"
            sleep 2
            count=$((count+2))
          done

          # ðŸš¨ DEBUG: If we timed out, show us why!
          if [ $count -ge 30 ]; then
            echo "âŒ Timed out waiting for Nginx."
            echo "--- DOCKER PS ---"
            docker-compose ps -a
            echo "--- NGINX LOGS ---"
            docker-compose logs nginx
            exit 1
          fi

      - name: ðŸ§ª Run Split
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REQUEST_PAYER: ${{ vars.AWS_REQUEST_PAYER }}
          AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
          CURL_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
        run: |
            uv run pytest -v \
            --splits 4 \
            --group ${{ matrix.split }} \
            --cov=mapchete \
            --cov-report=xml:coverage.xml \
            --junitxml="pytest-${{ matrix.python-version }}-${{ matrix.split }}.xml"

      - name: ðŸ“Š Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.xml
          flags: py${{ matrix.python-version }}-split${{ matrix.split }}
          fail_ci_if_error: true

      - name: ðŸ“¤ Archive JUnit Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.python-version }}-${{ matrix.split }}
          path: pytest-${{ matrix.python-version }}-${{ matrix.split }}.xml
          retention-days: 1

  summary:
    name: "ðŸ“Š Final Summary"
    needs: test
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Download All Results
        uses: actions/download-artifact@v4
        with:
          path: all-results
          pattern: results-*
          merge-multiple: true
      - name: ðŸ“Š Results of the Test Suite
        run: |
          echo "### ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          
          # Count XML files
          COUNT=$(ls all-results/*.xml 2>/dev/null | wc -l || echo "0")
          
          if [[ "${{ needs.test.result }}" == "success" ]]; then
            echo "âœ… **All tests passed!**" >> $GITHUB_STEP_SUMMARY
            echo "Successfully collected and verified $COUNT test report files." >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "âŒ **Some test splits failed.**" >> $GITHUB_STEP_SUMMARY
            echo "Review the 'test' matrix for specific logs. Collected $COUNT reports before failure." >> $GITHUB_STEP_SUMMARY
            echo "Check the 'Artifacts' section below to download individual JUnit XML reports." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi